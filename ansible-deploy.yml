---
- hosts: webserver
  become: true
  tasks:
    - name: Delete old Docker image
      shell: "sudo docker rmi renckel/fastapi-for-ci-cd:latest || true"

    - name: Pull Docker image
      shell: "sudo docker pull renckel/fastapi-for-ci-cd:latest"
    
    - name: Stop old container
      shell: "sudo docker stop target-project || true"

    - name: Remove old container  
      shell: "sudo docker rm target-project || true"

    - name: Run container
      environment:
        MYSQL_PASSWORD: "{{ lookup('ansible.builtin.env', 'MYSQL_PASSWORD') }}"
        JWT_SECRET: "{{ lookup('ansible.builtin.env', 'JWT_SECRET', default='secret') }}"
      shell: "sudo docker run --name target-project -p 80:80 -e MYSQL_USER='root' -e MYSQL_PASSWORD=$MYSQL_PASSWORD -e MYSQL_HOST='mysql-server-container' -e MYSQL_PORT='3306' -e MYSQL_DB='devops_finaltask_db' -e JWT_SECRET=$JWT_SECRET -d --network=target-app-net renckel/fastapi-for-ci-cd:latest"

    - name: Update database
      shell: "sudo docker exec target-project alembic -c app/alembic.ini stamp head"
